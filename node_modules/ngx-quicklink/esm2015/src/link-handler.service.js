import { Injectable, InjectionToken, NgZone } from '@angular/core';
import { RouterPreloader } from '@angular/router';
import { PrefetchRegistry } from './prefetch-registry.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
import * as ɵngcc2 from './prefetch-registry.service';
const ɵ0 = function (cb) {
    const start = Date.now();
    return setTimeout(function () {
        cb({
            didTimeout: false,
            timeRemaining: function () {
                return Math.max(0, 50 - (Date.now() - start));
            }
        });
    }, 1);
}, ɵ1 = () => { };
const requestIdleCallback = typeof window !== 'undefined'
    ? window.requestIdleCallback || ɵ0
    : ɵ1;
const observerSupported = () => typeof window !== 'undefined' ? !!window.IntersectionObserver : false;
const ɵ2 = observerSupported;
export const LinkHandler = new InjectionToken('LinkHandler');
export class ObservableLinkHandler {
    constructor(loader, registry, ngZone) {
        this.loader = loader;
        this.registry = registry;
        this.ngZone = ngZone;
        this.elementLink = new Map();
        this.observer = observerSupported()
            ? new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const link = entry.target;
                        const routerLink = this.elementLink.get(link);
                        if (!routerLink || !routerLink.urlTree)
                            return;
                        this.registry.add(routerLink.urlTree);
                        this.observer.unobserve(link);
                        requestIdleCallback(() => {
                            this.loader.preload().subscribe(() => void 0);
                        });
                    }
                });
            })
            : null;
    }
    register(el) {
        this.elementLink.set(el.element, el);
        this.ngZone.runOutsideAngular(() => {
            this.observer.observe(el.element);
        });
    }
    // First call to unregister will not hit this.
    unregister(el) {
        if (this.elementLink.has(el.element)) {
            this.observer.unobserve(el.element);
            this.elementLink.delete(el.element);
        }
    }
    supported() {
        return observerSupported();
    }
}
ObservableLinkHandler.ɵfac = function ObservableLinkHandler_Factory(t) { return new (t || ObservableLinkHandler)(ɵngcc0.ɵɵinject(ɵngcc1.RouterPreloader), ɵngcc0.ɵɵinject(ɵngcc2.PrefetchRegistry), ɵngcc0.ɵɵinject(ɵngcc0.NgZone)); };
ObservableLinkHandler.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: ObservableLinkHandler, factory: ObservableLinkHandler.ɵfac });
ObservableLinkHandler.ctorParameters = () => [
    { type: RouterPreloader },
    { type: PrefetchRegistry },
    { type: NgZone }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(ObservableLinkHandler, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.RouterPreloader }, { type: ɵngcc2.PrefetchRegistry }, { type: ɵngcc0.NgZone }]; }, null); })();
export class PreloadLinkHandler {
    constructor(loader, registry) {
        this.loader = loader;
        this.registry = registry;
    }
    register(el) {
        this.registry.add(el.urlTree);
        requestIdleCallback(() => this.loader.preload().subscribe(() => void 0));
    }
    unregister(_) { }
    supported() {
        return true;
    }
}
PreloadLinkHandler.ɵfac = function PreloadLinkHandler_Factory(t) { return new (t || PreloadLinkHandler)(ɵngcc0.ɵɵinject(ɵngcc1.RouterPreloader), ɵngcc0.ɵɵinject(ɵngcc2.PrefetchRegistry)); };
PreloadLinkHandler.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: PreloadLinkHandler, factory: PreloadLinkHandler.ɵfac });
PreloadLinkHandler.ctorParameters = () => [
    { type: RouterPreloader },
    { type: PrefetchRegistry }
];
/*@__PURE__*/ (function () { ɵngcc0.ɵsetClassMetadata(PreloadLinkHandler, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.RouterPreloader }, { type: ɵngcc2.PrefetchRegistry }]; }, null); })();
export { ɵ0, ɵ1, ɵ2 };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluay1oYW5kbGVyLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saW5rLWhhbmRsZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRWxELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDOzs7O0FBQy9ELFdBa0JNLFVBQVMsRUFBWTtBQUMzQixJQUFRLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztBQUNqQyxJQUFRLE9BQU8sVUFBVSxDQUFDO0FBQ3pCLFFBQVMsRUFBRSxDQUFDO0FBQ2IsWUFBWSxVQUFVLEVBQUUsS0FBSztBQUM3QixZQUFZLGFBQWEsRUFBRTtBQUMxQixnQkFBYSxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO0FBQzVELFlBQVksQ0FBQztBQUNiLFNBQVcsQ0FBQyxDQUFDO0FBQ2IsSUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDUixDQUFDLE9BQ0QsR0FBRyxFQUFFLEdBQUUsQ0FBQztBQWRkLE1BQU0sbUJBQW1CLEdBQ3ZCLE9BQU8sTUFBTSxLQUFLLFdBQVc7QUFDL0IsSUFBSSxDQUFDLENBQUUsTUFBYyxDQUFDLG1CQUFtQixNQVdsQztBQUNQLElBQUksQ0FBQyxHQUFTLENBQUM7QUFFZixNQUFNLGlCQUFpQixHQUFHLEdBQUcsRUFBRSxDQUM3QixPQUFPLE1BQU0sS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBRSxNQUFjLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztBQUNqRjtBQUNBLE1B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UUFBUSxDQUFrQjtBQUFDLElBQ2xDLENBQUM7QUFDTixJQUNFLFFBQVEsQ0FBQyxFQUFpQjtBQUM1QixRQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNsQyxRQUFJLG1CQUFtQixDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUM3RSxJQUFFLENBQUM7QUFDSCxJQUNFLFVBQVUsQ0FBQyxDQUFnQixJQUFHLENBQUM7QUFDakMsSUFDRSxTQUFTO0FBQ1gsUUFBSSxPQUFPLElBQUksQ0FBQztBQUNoQixJQUFFLENBQUM7QUFDSDs4Q0FqQkMsVUFBVTtzSEFDVDtBQUFDO0FBQTRDLFlBekZ0QyxlQUFlO0FBQUksWUFFbkIsZ0JBQWdCO0FBQUc7OzttSEFBRTtBQUFDO0FBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTGlua0RpcmVjdGl2ZSB9IGZyb20gJy4vbGluay5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgUm91dGVyUHJlbG9hZGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IExpbmtIYW5kbGVyU3RyYXRlZ3kgfSBmcm9tICcuL2xpbmstaGFuZGxlci1zdHJhdGVneSc7XG5pbXBvcnQgeyBQcmVmZXRjaFJlZ2lzdHJ5IH0gZnJvbSAnLi9wcmVmZXRjaC1yZWdpc3RyeS5zZXJ2aWNlJztcblxudHlwZSBSZXF1ZXN0SWRsZUNhbGxiYWNrSGFuZGxlID0gYW55O1xudHlwZSBSZXF1ZXN0SWRsZUNhbGxiYWNrT3B0aW9ucyA9IHtcbiAgdGltZW91dDogbnVtYmVyO1xufTtcbnR5cGUgUmVxdWVzdElkbGVDYWxsYmFja0RlYWRsaW5lID0ge1xuICByZWFkb25seSBkaWRUaW1lb3V0OiBib29sZWFuO1xuICB0aW1lUmVtYWluaW5nOiAoKCkgPT4gbnVtYmVyKTtcbn07XG5cbnR5cGUgUmVxdWVzdElkbGVDYWxsYmFjayA9ICgoXG4gIGNhbGxiYWNrOiAoKGRlYWRsaW5lOiBSZXF1ZXN0SWRsZUNhbGxiYWNrRGVhZGxpbmUpID0+IHZvaWQpLFxuICBvcHRzPzogUmVxdWVzdElkbGVDYWxsYmFja09wdGlvbnNcbikgPT4gUmVxdWVzdElkbGVDYWxsYmFja0hhbmRsZSk7XG5cbmNvbnN0IHJlcXVlc3RJZGxlQ2FsbGJhY2s6IFJlcXVlc3RJZGxlQ2FsbGJhY2sgPVxuICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJ1xuICAgID8gKHdpbmRvdyBhcyBhbnkpLnJlcXVlc3RJZGxlQ2FsbGJhY2sgfHxcbiAgICAgIGZ1bmN0aW9uKGNiOiBGdW5jdGlvbikge1xuICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGNiKHtcbiAgICAgICAgICAgIGRpZFRpbWVvdXQ6IGZhbHNlLFxuICAgICAgICAgICAgdGltZVJlbWFpbmluZzogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgIHJldHVybiBNYXRoLm1heCgwLCA1MCAtIChEYXRlLm5vdygpIC0gc3RhcnQpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSwgMSk7XG4gICAgICB9XG4gICAgOiAoKSA9PiB7fTtcblxuY29uc3Qgb2JzZXJ2ZXJTdXBwb3J0ZWQgPSAoKSA9PlxuICB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyA/ICEhKHdpbmRvdyBhcyBhbnkpLkludGVyc2VjdGlvbk9ic2VydmVyIDogZmFsc2U7XG5cbmV4cG9ydCBjb25zdCBMaW5rSGFuZGxlciA9IG5ldyBJbmplY3Rpb25Ub2tlbignTGlua0hhbmRsZXInKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE9ic2VydmFibGVMaW5rSGFuZGxlciBpbXBsZW1lbnRzIExpbmtIYW5kbGVyU3RyYXRlZ3kge1xuICBwcml2YXRlIGVsZW1lbnRMaW5rID0gbmV3IE1hcDxFbGVtZW50LCBMaW5rRGlyZWN0aXZlPigpO1xuICBwcml2YXRlIG9ic2VydmVyOiBJbnRlcnNlY3Rpb25PYnNlcnZlciB8IG51bGwgPSBvYnNlcnZlclN1cHBvcnRlZCgpXG4gICAgPyBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoZW50cmllcyA9PiB7XG4gICAgICAgIGVudHJpZXMuZm9yRWFjaChlbnRyeSA9PiB7XG4gICAgICAgICAgaWYgKGVudHJ5LmlzSW50ZXJzZWN0aW5nKSB7XG4gICAgICAgICAgICBjb25zdCBsaW5rID0gZW50cnkudGFyZ2V0IGFzIEhUTUxBbmNob3JFbGVtZW50O1xuXG4gICAgICAgICAgICBjb25zdCByb3V0ZXJMaW5rID0gdGhpcy5lbGVtZW50TGluay5nZXQobGluayk7XG4gICAgICAgICAgICBpZiAoICFyb3V0ZXJMaW5rIHx8ICFyb3V0ZXJMaW5rLnVybFRyZWUgKSByZXR1cm47XG5cbiAgICAgICAgICAgIHRoaXMucmVnaXN0cnkuYWRkKHJvdXRlckxpbmsudXJsVHJlZSk7XG4gICAgICAgICAgICB0aGlzLm9ic2VydmVyLnVub2JzZXJ2ZShsaW5rKTtcbiAgICAgICAgICAgIHJlcXVlc3RJZGxlQ2FsbGJhY2soKCkgPT4ge1xuICAgICAgICAgICAgICB0aGlzLmxvYWRlci5wcmVsb2FkKCkuc3Vic2NyaWJlKCgpID0+IHZvaWQgMCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSlcbiAgICA6IG51bGw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBsb2FkZXI6IFJvdXRlclByZWxvYWRlcixcbiAgICBwcml2YXRlIHJlZ2lzdHJ5OiBQcmVmZXRjaFJlZ2lzdHJ5LFxuICAgIHByaXZhdGUgbmdab25lOiBOZ1pvbmUsXG4gICkge31cblxuICByZWdpc3RlcihlbDogTGlua0RpcmVjdGl2ZSkge1xuICAgIHRoaXMuZWxlbWVudExpbmsuc2V0KGVsLmVsZW1lbnQsIGVsKTtcbiAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLm9ic2VydmVyLm9ic2VydmUoZWwuZWxlbWVudCk7XG4gICAgfSk7XG4gIH1cblxuICAvLyBGaXJzdCBjYWxsIHRvIHVucmVnaXN0ZXIgd2lsbCBub3QgaGl0IHRoaXMuXG4gIHVucmVnaXN0ZXIoZWw6IExpbmtEaXJlY3RpdmUpIHtcbiAgICBpZiAodGhpcy5lbGVtZW50TGluay5oYXMoZWwuZWxlbWVudCkpIHtcbiAgICAgIHRoaXMub2JzZXJ2ZXIudW5vYnNlcnZlKGVsLmVsZW1lbnQpO1xuICAgICAgdGhpcy5lbGVtZW50TGluay5kZWxldGUoZWwuZWxlbWVudCk7XG4gICAgfVxuICB9XG5cbiAgc3VwcG9ydGVkKCkge1xuICAgIHJldHVybiBvYnNlcnZlclN1cHBvcnRlZCgpO1xuICB9XG5cbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFByZWxvYWRMaW5rSGFuZGxlciBpbXBsZW1lbnRzIExpbmtIYW5kbGVyU3RyYXRlZ3kge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGxvYWRlcjogUm91dGVyUHJlbG9hZGVyLFxuICAgIHByaXZhdGUgcmVnaXN0cnk6IFByZWZldGNoUmVnaXN0cnksXG4gICkge31cblxuICByZWdpc3RlcihlbDogTGlua0RpcmVjdGl2ZSkge1xuICAgIHRoaXMucmVnaXN0cnkuYWRkKGVsLnVybFRyZWUpO1xuICAgIHJlcXVlc3RJZGxlQ2FsbGJhY2soKCkgPT4gdGhpcy5sb2FkZXIucHJlbG9hZCgpLnN1YnNjcmliZSgoKSA9PiB2b2lkIDApKTtcbiAgfVxuXG4gIHVucmVnaXN0ZXIoXzogTGlua0RpcmVjdGl2ZSkge31cblxuICBzdXBwb3J0ZWQoKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbn1cbiJdfQ==